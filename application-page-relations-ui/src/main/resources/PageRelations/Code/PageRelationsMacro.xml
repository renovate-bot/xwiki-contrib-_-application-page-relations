<?xml version="1.1" encoding="UTF-8"?>

<!--
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This is free software; you can redistribute it and/or modify it
 * under the terms of the GNU Lesser General Public License as
 * published by the Free Software Foundation; either version 2.1 of
 * the License, or (at your option) any later version.
 *
 * This software is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this software; if not, write to the Free
 * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
 * 02110-1301 USA, or see the FSF site: http://www.fsf.org.
-->

<xwikidoc version="1.4" reference="PageRelations.Code.PageRelationsMacro" locale="">
  <web>PageRelations.Code</web>
  <name>PageRelationsMacro</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <creator>xwiki:XWiki.Admin</creator>
  <parent>PageRelations.Code.WebHome</parent>
  <author>xwiki:XWiki.Admin</author>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <version>1.1</version>
  <title>Page Relations Macro</title>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>true</hidden>
  <content>{{pageRelations /}}</content>
  <object>
    <name>PageRelations.Code.PageRelationsMacro</name>
    <number>0</number>
    <className>XWiki.JavaScriptExtension</className>
    <guid>5bf10bc0-7c66-4b7a-94bb-bc8f9ee1a627</guid>
    <class>
      <name>XWiki.JavaScriptExtension</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <cache>
        <cache>0</cache>
        <defaultValue>long</defaultValue>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <freeText>forbidden</freeText>
        <largeStorage>0</largeStorage>
        <multiSelect>0</multiSelect>
        <name>cache</name>
        <number>5</number>
        <prettyName>Caching policy</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>long|short|default|forbid</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </cache>
      <code>
        <contenttype>PureText</contenttype>
        <disabled>0</disabled>
        <editor>PureText</editor>
        <name>code</name>
        <number>2</number>
        <prettyName>Code</prettyName>
        <rows>20</rows>
        <size>50</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </code>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <parse>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>parse</name>
        <number>4</number>
        <prettyName>Parse content</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </parse>
      <use>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <freeText>forbidden</freeText>
        <largeStorage>0</largeStorage>
        <multiSelect>0</multiSelect>
        <name>use</name>
        <number>3</number>
        <prettyName>Use this extension</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>currentPage|onDemand|always</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </use>
    </class>
    <property>
      <cache>long</cache>
    </property>
    <property>
      <code>
var XWiki = (function (XWiki) {

  function init() {
    require.config({
      paths: {'xwiki-selectize': "$xwiki.getSkinFile('uicomponents/suggest/xwiki.selectize.js', true)"}
    });

    //#set ($pageIcon = "$services.icon.getMetaData('page_white')")
    //console.log("$pageIcon");
    var pageIcon =  {
      cssClass: "fa fa-file-o",
      iconSetName: "Font Awesome",
      iconSetType: "FONT"};

    require(['jquery', 'xwiki-selectize'], function($, xwikiSelectize) {
      var getSelectizeOptions = function(select) {
        return {
          create: true,
          // The document where the selected values are saved. Stored document references will be relative to this document.
          documentReference: select.data('documentReference'),
          // Where to look for pages. The following is supported:
          // * "wiki:wikiName" look for pages in the specified wiki
          // * "space:spaceReference" look for pages in the specified space
          searchScope: select.data('searchScope'),
          // We overwrite the list of search fields because we don't want to match the technical "WebHome" nested page name
          // that appears in the value.
          searchField: ['query', 'label', 'hint'],
          sortField: 'score',
          load: function(text, callback) {
            loadPages(text, this.settings).done(callback).fail(callback);
          },
          loadSelected: function(text, callback) {
            loadPage(text, this.settings).done(callback).fail(callback);
          }
        }
      };

      var processOptions = function(options) {
        // Resolve the document reference relative to the current document reference.
        if (!options.documentReference || typeof options.documentReference === 'string') {
          options.documentReference = XWiki.Model.resolve(options.documentReference, XWiki.EntityType.DOCUMENT,
            XWiki.currentDocument.documentReference);
        }
        // Resolve the search scope.
        options.searchScope = resolveEntityReference(options.searchScope || 'wiki:' + XWiki.currentWiki);
        return options;
      };

      /**
       * Resolves an entity reference from a string representation of the form "entityType:entityReference".
       */
      var resolveEntityReference = function(typeAndReference) {
        if (typeof typeAndReference === 'string') {
          try {
            return XWiki.Model.resolve(typeAndReference, null, XWiki.currentDocument.documentReference);
          } catch (e) {
            return null;
          }
        }
        return typeAndReference;
      };

      var loadPages = function(text, options) {
        // We store the searched text into a variable because we will need it as a workaround for Selectize
        // to not filter out the results returned by the Solr endpoint whose neither the title nor the hint 
        // matches the searched text.
        // References:
        // - Selectize uses the Sifter library to perform a sort and a filtering on the received results
        //   Sifter: https://github.com/brianreavis/sifter.js/
        // - Selectize issues:
        //   - [Disable sifter functionality?](https://github.com/selectize/selectize.js/issues/196)
        //   - [Disable automatic sort](https://github.com/selectize/selectize.js/issues/218)
        // - It seems there is no good workaround for not filtering out entries sent by the server,
        //   so we use this hack.
        options.query = text;
        // Clear Selectize cache on each request otherwise Selectize performs wrong filtering in the following scenario:
        // 1) Search for "times" -&gt; "Modern Times" is returned
        // 2) Search for "goddard" -&gt; "Modern Times" is filtered out since its cached title, hint, and query (the previous one) do not match this new query.
        // Reference: [How to disable caching?](https://github.com/selectize/selectize.js/issues/1136)
        var selectized = $('.suggest-pages');
        selectized[0].selectize.clear();
        selectized[0].selectize.clearOptions();
        return $.getJSON(getRestSearchURL(options.searchScope), $.param({
          q: text,
          number: 10
        }, true)).then($.proxy(processPages, null, options));
      };

      var getRestSearchURL = function(searchScope) {
        return "${request.contextPath}/rest/wikis/query";
      };

      /**
       * Adapt the JSON returned by the REST call to the format expected by the Selectize widget.
       */
      var processPages = function(options, response) {
        if ($.isArray(response.searchResults)) {
          return response.searchResults.map($.proxy(processPage, null, options));
        } else {
          return [];
        }
      };

      var processPage = function(options, page) {
        console.log('processPage:options', options);
        // Value (relative to the current wiki, where it is saved)
        var documentReference = XWiki.Model.resolve(page.id, XWiki.EntityType.DOCUMENT);
        //var relativeReference = documentReference.relativeTo(options.documentReference.getRoot());
        // We need to store a full reference
        var value = XWiki.Model.serialize(documentReference);
        var label = page.title;
        var chain = documentReference.getReversedReferenceChain();
        var hint = chain.map(function(item) {
          return item.name;
        }).join(' / ');
        return {
          value: value,
          query: options.query,
          label: label,
          hint: hint,
          icon: pageIcon,
          url: new XWiki.Document(documentReference).getURL()
        };
      };

      $.fn.suggestPagesSolr = function(options) {
        return this.each(function() {
          var actualOptions = $.extend(getSelectizeOptions($(this)), options);
          $(this).xwikiSelectize(processOptions(actualOptions));
        });
      };

      var loadRelations = function() {
        var subject = XWiki.Model.serialize(XWiki.currentDocument.getDocumentReference());
        $('.page-relations-list').html("&lt;img src='$xwiki.getSkinFile('icons/xwiki/spinner.gif')'/&gt;");
        sendRequest("get-relations", subject, null, 'plain').done(function(data) {
          $('.page-relations-list').html(data);
          registerActionListeners();
        });
      }

      var createAddRelationForm = function(formHtmlString) {
        var addRelationFormContainer = $('.page-relations-add-form-container');
        var addRelationButton = $('.page-relations-add-action');
        addRelationButton.hide();
        addRelationFormContainer.html(formHtmlString);
        var form = addRelationFormContainer.find("form");
        form.submit(function(event) {
          event.preventDefault();
          // TODO: ignore cascade clicks by disabling the form
          var input = form.find(".xwiki-selectize-option");
          var subject = form.find("input[name='subject']").val();
          var complement = input.data('value');
          var subjectReference = XWiki.Model.resolve(subject, XWiki.EntityType.DOCUMENT);
          var complementReference = XWiki.Model.resolve(complement, XWiki.EntityType.DOCUMENT);
          // NB: obtaining the subject's wiki could rather be done via xwiki-meta instead
          var subjectWiki = subjectReference.extractReference(XWiki.EntityType.WIKI);
          var complementWiki = complementReference.extractReference(XWiki.EntityType.WIKI);
          console.log('references', subjectReference, complementReference);
          if (complementWiki.name === subjectWiki.name) {
            var index = complement.indexOf(':');
            complement = complement.substring(index + 1);
          }
          var notification = new XWiki.widgets.Notification("$services.localization.render('pagerelations.adding-relation')", "inprogress");
          sendRequest("add-relation", subject, complement, 'plain').done(function (data) {
            form.remove();
            addRelationButton.show();
            notification.hide();
            loadRelations();
          });
        });
        var cancelButton = form.find(".add-relation-cancel");
        cancelButton.click(function() {
          form.remove();
          addRelationButton.show();
        });
        $('.suggest-pages').suggestPagesSolr();
        var selectized = $('.suggest-pages');
        selectized[0].selectize.focus();
      }

      $('a.page-relations-add-action').on('click', function(event) {
        event.preventDefault();
        var subject = $(this).data('subject');
        var notification = new XWiki.widgets.Notification("$services.localization.render('pagerelations.preparing-relation-addition')", "inprogress");
        sendRequest('get-add-relation-form', subject, 'html').done(function (data) {
          notification.hide();
          createAddRelationForm(data);
        });
      });

      var registerActionListeners = function() {
        $('.page-relations-term-action-remove').on('click', function(event) {
          event.preventDefault();
          var relationListItem = $(this).parent();
          var subject = $(this).find('a').data('subject');
          var complement = $(this).find('a').data('complement');
          var notification = new XWiki.widgets.Notification("$services.localization.render('pagerelations.removing-relation')", "inprogress");
          sendRequest('remove-relation', subject, complement, 'plain').done(function (data) {
            notification.hide();
            new XWiki.widgets.Notification("$services.localization.render('pagerelations.relation-removed')", "done");
            relationListItem.remove();
          }).fail(function(data) {
            notification.hide();
            new XWiki.widgets.Notification("$services.localization.render('pagerelations.relation-not-found')", "warning");
          });
        });
      }

      var sendRequest = function(action, subject, complement, outputSyntax) {
        var reference = XWiki.Model.resolve('PageRelations.Code.PageRelationsService', XWiki.EntityType.DOCUMENT);
        var relationService = new XWiki.Document(reference);

        return $.ajax({
          type: 'post',
          url: relationService.getURL('view'),
          data: {
            action: action,
            subject: subject,
            complement: complement,
            xpage: "plain",
            outputSyntax: outputSyntax
          },
          cache: false,
        });
      }

      loadRelations();
    });

  }

  (XWiki.domIsLoaded &amp;&amp; init()) || document.observe('xwiki:dom:loaded', init);
  return XWiki;
}(XWiki || {}));</code>
    </property>
    <property>
      <name/>
    </property>
    <property>
      <parse>1</parse>
    </property>
    <property>
      <use>onDemand</use>
    </property>
  </object>
  <object>
    <name>PageRelations.Code.PageRelationsMacro</name>
    <number>0</number>
    <className>XWiki.StyleSheetExtension</className>
    <guid>6a97e89f-64df-4339-a8c7-190ed7248489</guid>
    <class>
      <name>XWiki.StyleSheetExtension</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <cache>
        <cache>0</cache>
        <defaultValue>long</defaultValue>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <freeText>forbidden</freeText>
        <largeStorage>0</largeStorage>
        <multiSelect>0</multiSelect>
        <name>cache</name>
        <number>5</number>
        <prettyName>Caching policy</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>long|short|default|forbid</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </cache>
      <code>
        <contenttype>PureText</contenttype>
        <disabled>0</disabled>
        <editor>PureText</editor>
        <name>code</name>
        <number>2</number>
        <prettyName>Code</prettyName>
        <rows>20</rows>
        <size>50</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </code>
      <contentType>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <freeText>forbidden</freeText>
        <largeStorage>0</largeStorage>
        <multiSelect>0</multiSelect>
        <name>contentType</name>
        <number>6</number>
        <prettyName>Content Type</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>CSS|LESS</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </contentType>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <parse>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>parse</name>
        <number>4</number>
        <prettyName>Parse content</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </parse>
      <use>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <freeText>forbidden</freeText>
        <largeStorage>0</largeStorage>
        <multiSelect>0</multiSelect>
        <name>use</name>
        <number>3</number>
        <prettyName>Use this extension</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>currentPage|onDemand|always</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </use>
    </class>
    <property>
      <cache>long</cache>
    </property>
    <property>
      <code>form.page-relation-add {
  display: block;
  margin-top: 0.5em;
  background: #f1f1f1;
  padding: 0.7em;
  z-index: 3;
  border: 1px solid #ddd;
  max-width: 700px;
}

.page-relations-uix-container {
  .panel-heading p {
    margin: 0;
  }
}

.page-relations-term-container {
  display: inline-block;
  line-height: 3.5rem;
  .page-relations-term {
    background: #d0dfee;
    padding: 0.5rem 0.8rem 0.5rem 1.2rem;
    border-radius: 0.3rem 0 0 0.3rem;
  }
  .page-relations-term-action-remove {
    background: whitesmoke;
    padding: 0.5rem 0.8rem;
    border-radius: 0 0.3rem 0.3rem 0;
    &amp;:hover {
      background: #e8e8e8;
    }
    cursor: pointer;
    a {
      text-decoration: none;
      color: #757763;
    }
  }
}

@media screen and (min-width: 768px) {
  .page-relations-uix-container {
    form.page-relation-add {
      .page-relation-add-suggest {
        width: 70%;
      }
      .page-relation-add-actions {
        width: 30%;
      }
    }
  }
}</code>
    </property>
    <property>
      <contentType>LESS</contentType>
    </property>
    <property>
      <name/>
    </property>
    <property>
      <parse>0</parse>
    </property>
    <property>
      <use>onDemand</use>
    </property>
  </object>
  <object>
    <name>PageRelations.Code.PageRelationsMacro</name>
    <number>0</number>
    <className>XWiki.WikiMacroClass</className>
    <guid>4071bad7-aed5-425e-b867-f00ab34bfb5f</guid>
    <class>
      <name>XWiki.WikiMacroClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <async_cached>
        <defaultValue>0</defaultValue>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType/>
        <name>async_cached</name>
        <number>12</number>
        <prettyName>Cached</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </async_cached>
      <async_context>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <freeText>forbidden</freeText>
        <largeStorage>0</largeStorage>
        <multiSelect>1</multiSelect>
        <name>async_context</name>
        <number>13</number>
        <prettyName>Context elements</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator>, </separator>
        <separators>|, </separators>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <values>action=Action|doc.reference=Document|icon.theme=Icon theme|locale=Language|rendering.defaultsyntax=Default syntax|rendering.restricted=Restricted|rendering.targetsyntax=Target syntax|request.base=Request base URL|request.parameters=Request parameters|request.url=Request URL|request.wiki=Request wiki|user=User|wiki=Wiki</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </async_context>
      <async_enabled>
        <defaultValue>0</defaultValue>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType/>
        <name>async_enabled</name>
        <number>11</number>
        <prettyName>Asynchronous rendering</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </async_enabled>
      <code>
        <disabled>0</disabled>
        <editor>Text</editor>
        <name>code</name>
        <number>10</number>
        <prettyName>Macro code</prettyName>
        <rows>20</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </code>
      <contentDescription>
        <contenttype>PureText</contenttype>
        <disabled>0</disabled>
        <editor>PureText</editor>
        <name>contentDescription</name>
        <number>9</number>
        <prettyName>Content description (Not applicable for "No content" type)</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </contentDescription>
      <contentJavaType>
        <cache>0</cache>
        <defaultValue>Unknown</defaultValue>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <freeText>allowed</freeText>
        <largeStorage>1</largeStorage>
        <multiSelect>0</multiSelect>
        <name>contentJavaType</name>
        <number>8</number>
        <picker>1</picker>
        <prettyName>Macro content type</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator>|</separator>
        <separators>|</separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>Unknown|Wiki</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </contentJavaType>
      <contentType>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <freeText>forbidden</freeText>
        <largeStorage>0</largeStorage>
        <multiSelect>0</multiSelect>
        <name>contentType</name>
        <number>7</number>
        <prettyName>Macro content availability</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator>|</separator>
        <separators>|</separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>Optional|Mandatory|No content</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </contentType>
      <defaultCategory>
        <disabled>0</disabled>
        <name>defaultCategory</name>
        <number>4</number>
        <prettyName>Default category</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </defaultCategory>
      <description>
        <contenttype>PureText</contenttype>
        <disabled>0</disabled>
        <editor>PureText</editor>
        <name>description</name>
        <number>3</number>
        <prettyName>Macro description</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </description>
      <id>
        <disabled>0</disabled>
        <name>id</name>
        <number>1</number>
        <prettyName>Macro id</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </id>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>2</number>
        <prettyName>Macro name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <supportsInlineMode>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>supportsInlineMode</name>
        <number>5</number>
        <prettyName>Supports inline mode</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </supportsInlineMode>
      <visibility>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <freeText>forbidden</freeText>
        <largeStorage>0</largeStorage>
        <multiSelect>0</multiSelect>
        <name>visibility</name>
        <number>6</number>
        <prettyName>Macro visibility</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator>|</separator>
        <separators>|</separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>Current User|Current Wiki|Global</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </visibility>
    </class>
    <property>
      <async_cached>0</async_cached>
    </property>
    <property>
      <async_context/>
    </property>
    <property>
      <async_enabled>0</async_enabled>
    </property>
    <property>
      <code>{{velocity}}
#set ($discard = $xwiki.ssx.use('PageRelations.Code.PageRelationsMacro'))
#set ($discard = $xwiki.jsx.use('PageRelations.Code.PageRelationsMacro'))
{{html clean="false"}}
&lt;div class="page-relations-container"&gt;
  &lt;div class="page-relations-list"&gt;&lt;/div&gt;
   #if ($services.security.authorization.hasAccess('edit', $doc.documentReference))
    &lt;div class="page-relations-add-section"&gt;
      &lt;a class="btn btn-primary page-relations-add-action" title="Add relation from this page to another one" data-subject="$doc.documentReference" href="#"&gt;+&lt;/a&gt;
      &lt;div class="page-relations-add-form-container"&gt;&lt;/div&gt;
    &lt;/div&gt;
  #end
&lt;/div&gt;
{{/html}}
{{/velocity}}
</code>
    </property>
    <property>
      <contentDescription/>
    </property>
    <property>
      <contentJavaType/>
    </property>
    <property>
      <contentType>No content</contentType>
    </property>
    <property>
      <defaultCategory>Content</defaultCategory>
    </property>
    <property>
      <description/>
    </property>
    <property>
      <id>pageRelations</id>
    </property>
    <property>
      <name>Page relations</name>
    </property>
    <property>
      <supportsInlineMode>0</supportsInlineMode>
    </property>
    <property>
      <visibility/>
    </property>
  </object>
  <object>
    <name>PageRelations.Code.PageRelationsMacro</name>
    <number>0</number>
    <className>XWiki.WikiMacroParameterClass</className>
    <guid>a3902c3c-90d5-4f8e-bbdf-e80b8a471710</guid>
    <class>
      <name>XWiki.WikiMacroParameterClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <defaultValue>
        <disabled>0</disabled>
        <name>defaultValue</name>
        <number>4</number>
        <prettyName>Parameter default value</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </defaultValue>
      <description>
        <disabled>0</disabled>
        <name>description</name>
        <number>2</number>
        <prettyName>Parameter description</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </description>
      <mandatory>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>mandatory</name>
        <number>3</number>
        <prettyName>Parameter mandatory</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </mandatory>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Parameter name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <type>
        <disabled>0</disabled>
        <name>type</name>
        <number>5</number>
        <prettyName>Parameter type</prettyName>
        <size>60</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </type>
    </class>
    <property>
      <defaultValue>true</defaultValue>
    </property>
    <property>
      <description>Whether to show the facets / relations titles or not.</description>
    </property>
    <property>
      <mandatory>0</mandatory>
    </property>
    <property>
      <name>showTitles</name>
    </property>
    <property>
      <type/>
    </property>
  </object>
  <object>
    <name>PageRelations.Code.PageRelationsMacro</name>
    <number>1</number>
    <className>XWiki.WikiMacroParameterClass</className>
    <guid>df6effbd-5542-42d0-8513-d506ab9a9c19</guid>
    <class>
      <name>XWiki.WikiMacroParameterClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <defaultValue>
        <disabled>0</disabled>
        <name>defaultValue</name>
        <number>4</number>
        <prettyName>Parameter default value</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </defaultValue>
      <description>
        <disabled>0</disabled>
        <name>description</name>
        <number>2</number>
        <prettyName>Parameter description</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </description>
      <mandatory>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>mandatory</name>
        <number>3</number>
        <prettyName>Parameter mandatory</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </mandatory>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Parameter name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <type>
        <disabled>0</disabled>
        <name>type</name>
        <number>5</number>
        <prettyName>Parameter type</prettyName>
        <size>60</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </type>
    </class>
    <property>
      <defaultValue>false</defaultValue>
    </property>
    <property>
      <description>Whether to display the second degree relations with high connections with the first degree relations or not.</description>
    </property>
    <property>
      <mandatory>0</mandatory>
    </property>
    <property>
      <name>showFacets</name>
    </property>
    <property>
      <type/>
    </property>
  </object>
  <object>
    <name>PageRelations.Code.PageRelationsMacro</name>
    <number>2</number>
    <className>XWiki.WikiMacroParameterClass</className>
    <guid>606da44b-fbe6-4292-a4c4-4d69c8887dab</guid>
    <class>
      <name>XWiki.WikiMacroParameterClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <defaultValue>
        <disabled>0</disabled>
        <name>defaultValue</name>
        <number>4</number>
        <prettyName>Parameter default value</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </defaultValue>
      <description>
        <disabled>0</disabled>
        <name>description</name>
        <number>2</number>
        <prettyName>Parameter description</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </description>
      <mandatory>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>mandatory</name>
        <number>3</number>
        <prettyName>Parameter mandatory</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </mandatory>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Parameter name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <type>
        <disabled>0</disabled>
        <name>type</name>
        <number>5</number>
        <prettyName>Parameter type</prettyName>
        <size>60</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </type>
    </class>
    <property>
      <defaultValue/>
    </property>
    <property>
      <description>Display a border around the relations and clusters or not</description>
    </property>
    <property>
      <mandatory>0</mandatory>
    </property>
    <property>
      <name>showBorder</name>
    </property>
    <property>
      <type/>
    </property>
  </object>
</xwikidoc>
